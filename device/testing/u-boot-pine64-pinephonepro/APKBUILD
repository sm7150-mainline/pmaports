# Mainline u-boot with the PinePhone Pro device tree and config
pkgname=u-boot-pine64-pinephonepro
pkgver=2022.01
pkgrel=0
pkgdesc="u-boot bootloader for the pinephone pro"
url="https://git.sr.ht/~martijnbraam/u-boot"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
makedepends="$depends_dev
	arm-trusted-firmware
	bc
	bison
	dtc
	flex
	openssl-dev
	python3-dev
	swig
	"
options="!check"
source="http://source.denx.de/u-boot/u-boot/-/archive/v$pkgver/u-boot-v$pkgver.tar.gz
	0001-rockchip-Add-initial-support-for-the-PinePhone-Pro.patch
	0002-Correct-boot-order-to-be-USB-SD-eMMC.patch
	0003-Configure-USB-power-settings-for-PinePhone-Pro.patch
	0004-rockchip-sdhci-Fix-reinit-and-add-HS400-Enhanced-Strobe-support.patch
	"
builddir="$srcdir/u-boot-v$pkgver"

build() {
	touch include/config.h
	LC_ALL=C date +'#define U_BOOT_DATE "%b %d %C%y"' > include/timestamp_autogenerated.h
	LC_ALL=C date +'#define U_BOOT_TIME "%T"' >> include/timestamp_autogenerated.h

	export BL31="/usr/share/arm-trusted-firmware/rk3399/bl31.elf"
	export BUILD_DIR="$builddir"/build
	mkdir -p "$BUILD_DIR"
	make O="$BUILD_DIR" HOSTCC=gcc ARCH=arm pinephone-pro-rk3399_defconfig
	make O="$BUILD_DIR" HOSTCC=gcc ARCH=arm all
}

package() {
	install -D -m644 build/u-boot-rockchip.bin \
		"$pkgdir"/usr/share/u-boot/pine64-pinephonepro/u-boot-rockchip.bin
}


sha512sums="
658fdea3c67ad69f10270cb76ee9e1de9b6572c6f0e6cf8c67a32f475f342b336d3e742ec58d0e67336570d249a453582cb92481568c00bb0865ee091f684c92  u-boot-v2022.01.tar.gz
00559a651a16d600cc5b293c8376d1e5038d994bb58de5a4a2a8cb2fe8b620d1dc0789f4157d0cb64203b0bd7d6402a872d5ef23d9a54d243221907c34545f0a  0001-rockchip-Add-initial-support-for-the-PinePhone-Pro.patch
1d3d90308c97ff4fb54e00785721bde02bc3abbb9f8bcf5ce2f4604456c5365e52d33c45c112563146587b0fe7e0d8740a0fe83043657a58d9b0c6402f2564d5  0002-Correct-boot-order-to-be-USB-SD-eMMC.patch
312d29495facbca755cee1638c67f76d82446287d95241bee637975a6ca53e76d0a5389be3e83dc7d07095e8bc18ede8c573f848a8c8191fcd3eabbeecad7d6c  0003-Configure-USB-power-settings-for-PinePhone-Pro.patch
2083bf9eda439bff5758ff295d140d839b8326662f0a8f34997ab518e9c3e023bf2d4e3d56d72985959e29362e366cd79c7b619e1341474943acef63399300bd  0004-rockchip-sdhci-Fix-reinit-and-add-HS400-Enhanced-Strobe-support.patch
"
